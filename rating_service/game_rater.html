<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>server.rating_service.game_rater API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>server.rating_service.game_rater</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">import trueskill

from server.config import config
from server.games.game_results import GameOutcome
from server.rating import Rating
from server.rating_service.typedefs import GameRatingSummary

from ..decorators import with_logger
from .typedefs import PlayerID, RatingDict


class GameRatingError(Exception):
    pass


@with_logger
class GameRater:
    def __init__(self, summary: GameRatingSummary):
        self.summary = summary
        self.outcome_map = {
            player_id: team.outcome
            for team in summary.teams
            for player_id in team.player_ids
        }
        self.player_ids = list(self.outcome_map.keys())
        self.team_outcomes = [team.outcome for team in summary.teams]
        self.ranks = _ranks_from_team_outcomes(self.team_outcomes)

    def compute_rating(
        self,
        ratings: RatingDict
    ) -&gt; RatingDict:
        rating_groups = [
            {
                player_id: trueskill.Rating(*ratings[player_id])
                for player_id in team.player_ids
            }
            for team in self.summary.teams
        ]

        self._logger.debug(&#34;Rating groups: %s&#34;, rating_groups)
        self._logger.debug(&#34;Ranks: %s&#34;, self.ranks)

        new_rating_groups = trueskill.rate(rating_groups, self.ranks)

        player_rating_map = {
            player_id: Rating(*new_rating)
            for team in new_rating_groups
            for player_id, new_rating in team.items()
        }

        return player_rating_map

    def get_outcome_map(self) -&gt; dict[PlayerID, GameOutcome]:
        return self.outcome_map


@with_logger
class AdjustmentGameRater(GameRater):
    &#34;&#34;&#34;GameRater for performing adjustments using another GameRater&#34;&#34;&#34;

    def __init__(self, rater: GameRater, base_ratings: RatingDict):
        self.rater = rater
        self.base_ratings = base_ratings

    def compute_rating(
        self,
        ratings: RatingDict
    ) -&gt; RatingDict:
        &#34;&#34;&#34;
        Adjust one rating to bring it closer to a different base rating. For
        each player, this will rate the game with trueskill as if they
        played this game with the rating we are adjusting instead of the
        base rating. Adjustments are only returned under certain conditions to
        prevent rating manipulation.
        &#34;&#34;&#34;
        new_adjusted_ratings = {}
        for player_id, base_rating in self.base_ratings.items():
            old_adjusted_rating = ratings[player_id]
            # Since we only adjust upwards, we should not adjust ratings that
            # are already higher than the base.
            if base_rating.displayed() &lt; old_adjusted_rating.displayed():
                continue
            # Make a copy of the base ratings, but substitute this player&#39;s
            # rating with the rating we are adjusting.
            old_ratings = dict(self.base_ratings)
            old_ratings[player_id] = old_adjusted_rating

            new_ratings = self.rater.compute_rating(old_ratings)
            new_adjusted_rating = new_ratings[player_id]
            self._logger.debug(
                &#34;Got new adjusted rating for player %d: %s&#34;,
                player_id,
                new_adjusted_rating
            )
            if (
                old_adjusted_rating.displayed() &lt;
                new_adjusted_rating.displayed() &lt;=
                config.RATING_ADJUSTMENT_MAX_RATING
            ):
                new_adjusted_ratings[player_id] = new_adjusted_rating

        return new_adjusted_ratings

    def get_outcome_map(self) -&gt; dict[PlayerID, GameOutcome]:
        return self.rater.outcome_map


def _ranks_from_team_outcomes(outcomes: list[GameOutcome]) -&gt; list[int]:
    if outcomes == [GameOutcome.DRAW, GameOutcome.DRAW]:
        return [0, 0]
    elif outcomes == [GameOutcome.VICTORY, GameOutcome.DEFEAT]:
        return [0, 1]
    elif outcomes == [GameOutcome.DEFEAT, GameOutcome.VICTORY]:
        return [1, 0]
    else:
        raise GameRatingError(f&#34;Inconsistent outcomes {outcomes}&#34;)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="server.rating_service.game_rater.AdjustmentGameRater"><code class="flex name class">
<span>class <span class="ident">AdjustmentGameRater</span></span>
<span>(</span><span>rater: <a title="server.rating_service.game_rater.GameRater" href="#server.rating_service.game_rater.GameRater">GameRater</a>, base_ratings: dict[int, <a title="server.rating.Rating" href="../rating.html#server.rating.Rating">Rating</a>])</span>
</code></dt>
<dd>
<div class="desc"><p>GameRater for performing adjustments using another GameRater</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@with_logger
class AdjustmentGameRater(GameRater):
    &#34;&#34;&#34;GameRater for performing adjustments using another GameRater&#34;&#34;&#34;

    def __init__(self, rater: GameRater, base_ratings: RatingDict):
        self.rater = rater
        self.base_ratings = base_ratings

    def compute_rating(
        self,
        ratings: RatingDict
    ) -&gt; RatingDict:
        &#34;&#34;&#34;
        Adjust one rating to bring it closer to a different base rating. For
        each player, this will rate the game with trueskill as if they
        played this game with the rating we are adjusting instead of the
        base rating. Adjustments are only returned under certain conditions to
        prevent rating manipulation.
        &#34;&#34;&#34;
        new_adjusted_ratings = {}
        for player_id, base_rating in self.base_ratings.items():
            old_adjusted_rating = ratings[player_id]
            # Since we only adjust upwards, we should not adjust ratings that
            # are already higher than the base.
            if base_rating.displayed() &lt; old_adjusted_rating.displayed():
                continue
            # Make a copy of the base ratings, but substitute this player&#39;s
            # rating with the rating we are adjusting.
            old_ratings = dict(self.base_ratings)
            old_ratings[player_id] = old_adjusted_rating

            new_ratings = self.rater.compute_rating(old_ratings)
            new_adjusted_rating = new_ratings[player_id]
            self._logger.debug(
                &#34;Got new adjusted rating for player %d: %s&#34;,
                player_id,
                new_adjusted_rating
            )
            if (
                old_adjusted_rating.displayed() &lt;
                new_adjusted_rating.displayed() &lt;=
                config.RATING_ADJUSTMENT_MAX_RATING
            ):
                new_adjusted_ratings[player_id] = new_adjusted_rating

        return new_adjusted_ratings

    def get_outcome_map(self) -&gt; dict[PlayerID, GameOutcome]:
        return self.rater.outcome_map</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="server.rating_service.game_rater.GameRater" href="#server.rating_service.game_rater.GameRater">GameRater</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="server.rating_service.game_rater.AdjustmentGameRater.compute_rating"><code class="name flex">
<span>def <span class="ident">compute_rating</span></span>(<span>self, ratings: dict[int, <a title="server.rating.Rating" href="../rating.html#server.rating.Rating">Rating</a>]) ‑> dict[int, <a title="server.rating.Rating" href="../rating.html#server.rating.Rating">Rating</a>]</span>
</code></dt>
<dd>
<div class="desc"><p>Adjust one rating to bring it closer to a different base rating. For
each player, this will rate the game with trueskill as if they
played this game with the rating we are adjusting instead of the
base rating. Adjustments are only returned under certain conditions to
prevent rating manipulation.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def compute_rating(
    self,
    ratings: RatingDict
) -&gt; RatingDict:
    &#34;&#34;&#34;
    Adjust one rating to bring it closer to a different base rating. For
    each player, this will rate the game with trueskill as if they
    played this game with the rating we are adjusting instead of the
    base rating. Adjustments are only returned under certain conditions to
    prevent rating manipulation.
    &#34;&#34;&#34;
    new_adjusted_ratings = {}
    for player_id, base_rating in self.base_ratings.items():
        old_adjusted_rating = ratings[player_id]
        # Since we only adjust upwards, we should not adjust ratings that
        # are already higher than the base.
        if base_rating.displayed() &lt; old_adjusted_rating.displayed():
            continue
        # Make a copy of the base ratings, but substitute this player&#39;s
        # rating with the rating we are adjusting.
        old_ratings = dict(self.base_ratings)
        old_ratings[player_id] = old_adjusted_rating

        new_ratings = self.rater.compute_rating(old_ratings)
        new_adjusted_rating = new_ratings[player_id]
        self._logger.debug(
            &#34;Got new adjusted rating for player %d: %s&#34;,
            player_id,
            new_adjusted_rating
        )
        if (
            old_adjusted_rating.displayed() &lt;
            new_adjusted_rating.displayed() &lt;=
            config.RATING_ADJUSTMENT_MAX_RATING
        ):
            new_adjusted_ratings[player_id] = new_adjusted_rating

    return new_adjusted_ratings</code></pre>
</details>
</dd>
<dt id="server.rating_service.game_rater.AdjustmentGameRater.get_outcome_map"><code class="name flex">
<span>def <span class="ident">get_outcome_map</span></span>(<span>self) ‑> dict[int, <a title="server.db.typedefs.GameOutcome" href="../db/typedefs.html#server.db.typedefs.GameOutcome">GameOutcome</a>]</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_outcome_map(self) -&gt; dict[PlayerID, GameOutcome]:
    return self.rater.outcome_map</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="server.rating_service.game_rater.GameRater"><code class="flex name class">
<span>class <span class="ident">GameRater</span></span>
<span>(</span><span>summary: <a title="server.rating_service.typedefs.GameRatingSummary" href="typedefs.html#server.rating_service.typedefs.GameRatingSummary">GameRatingSummary</a>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@with_logger
class GameRater:
    def __init__(self, summary: GameRatingSummary):
        self.summary = summary
        self.outcome_map = {
            player_id: team.outcome
            for team in summary.teams
            for player_id in team.player_ids
        }
        self.player_ids = list(self.outcome_map.keys())
        self.team_outcomes = [team.outcome for team in summary.teams]
        self.ranks = _ranks_from_team_outcomes(self.team_outcomes)

    def compute_rating(
        self,
        ratings: RatingDict
    ) -&gt; RatingDict:
        rating_groups = [
            {
                player_id: trueskill.Rating(*ratings[player_id])
                for player_id in team.player_ids
            }
            for team in self.summary.teams
        ]

        self._logger.debug(&#34;Rating groups: %s&#34;, rating_groups)
        self._logger.debug(&#34;Ranks: %s&#34;, self.ranks)

        new_rating_groups = trueskill.rate(rating_groups, self.ranks)

        player_rating_map = {
            player_id: Rating(*new_rating)
            for team in new_rating_groups
            for player_id, new_rating in team.items()
        }

        return player_rating_map

    def get_outcome_map(self) -&gt; dict[PlayerID, GameOutcome]:
        return self.outcome_map</code></pre>
</details>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="server.rating_service.game_rater.AdjustmentGameRater" href="#server.rating_service.game_rater.AdjustmentGameRater">AdjustmentGameRater</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="server.rating_service.game_rater.GameRater.compute_rating"><code class="name flex">
<span>def <span class="ident">compute_rating</span></span>(<span>self, ratings: dict[int, <a title="server.rating.Rating" href="../rating.html#server.rating.Rating">Rating</a>]) ‑> dict[int, <a title="server.rating.Rating" href="../rating.html#server.rating.Rating">Rating</a>]</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def compute_rating(
    self,
    ratings: RatingDict
) -&gt; RatingDict:
    rating_groups = [
        {
            player_id: trueskill.Rating(*ratings[player_id])
            for player_id in team.player_ids
        }
        for team in self.summary.teams
    ]

    self._logger.debug(&#34;Rating groups: %s&#34;, rating_groups)
    self._logger.debug(&#34;Ranks: %s&#34;, self.ranks)

    new_rating_groups = trueskill.rate(rating_groups, self.ranks)

    player_rating_map = {
        player_id: Rating(*new_rating)
        for team in new_rating_groups
        for player_id, new_rating in team.items()
    }

    return player_rating_map</code></pre>
</details>
</dd>
<dt id="server.rating_service.game_rater.GameRater.get_outcome_map"><code class="name flex">
<span>def <span class="ident">get_outcome_map</span></span>(<span>self) ‑> dict[int, <a title="server.db.typedefs.GameOutcome" href="../db/typedefs.html#server.db.typedefs.GameOutcome">GameOutcome</a>]</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_outcome_map(self) -&gt; dict[PlayerID, GameOutcome]:
    return self.outcome_map</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="server.rating_service.game_rater.GameRatingError"><code class="flex name class">
<span>class <span class="ident">GameRatingError</span></span>
<span>(</span><span>*args, **kwargs)</span>
</code></dt>
<dd>
<div class="desc"><p>Common base class for all non-exit exceptions.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class GameRatingError(Exception):
    pass</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li>builtins.Exception</li>
<li>builtins.BaseException</li>
</ul>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="server.rating_service" href="index.html">server.rating_service</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="server.rating_service.game_rater.AdjustmentGameRater" href="#server.rating_service.game_rater.AdjustmentGameRater">AdjustmentGameRater</a></code></h4>
<ul class="">
<li><code><a title="server.rating_service.game_rater.AdjustmentGameRater.compute_rating" href="#server.rating_service.game_rater.AdjustmentGameRater.compute_rating">compute_rating</a></code></li>
<li><code><a title="server.rating_service.game_rater.AdjustmentGameRater.get_outcome_map" href="#server.rating_service.game_rater.AdjustmentGameRater.get_outcome_map">get_outcome_map</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="server.rating_service.game_rater.GameRater" href="#server.rating_service.game_rater.GameRater">GameRater</a></code></h4>
<ul class="">
<li><code><a title="server.rating_service.game_rater.GameRater.compute_rating" href="#server.rating_service.game_rater.GameRater.compute_rating">compute_rating</a></code></li>
<li><code><a title="server.rating_service.game_rater.GameRater.get_outcome_map" href="#server.rating_service.game_rater.GameRater.get_outcome_map">get_outcome_map</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="server.rating_service.game_rater.GameRatingError" href="#server.rating_service.game_rater.GameRatingError">GameRatingError</a></code></h4>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>